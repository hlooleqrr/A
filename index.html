<script>
let answers = {}, commitments = [], curCommit = {};

// عرض المحتوى في الصفحة
function show(html) {
  document.getElementById('question').innerHTML = '<div class="fade-in">' + html + '</div>';
}

// زر البدء
function start() {
  document.getElementById('startBtn').innerText = 'أعد الحسبة';
  answers = {}; commitments = []; curCommit = {};
  askFinanceType();
}

// سؤال: نوع التمويل
function askFinanceType() {
  show(`
    <label>نوع التمويل:</label><br>
    <select id="ft">
      <option>تمويل عقاري</option>
      <option>تمويل شخصي</option>
    </select><br>
    <button onclick="saveFinanceType()">التالي</button>
  `);
}

// حفظ نوع التمويل
function saveFinanceType() {
  answers.financeType = document.getElementById('ft').value;
  (answers.financeType === 'تمويل عقاري') ? askSupport() : askSalary();
}

// سؤال: هل التمويل مدعوم؟
function askSupport() {
  show(`
    <label>هل التمويل مدعوم؟</label><br>
    <select id="sup"><option>مدعوم</option><option>غير مدعوم</option></select><br>
    <button onclick="saveSupport()">التالي</button>
  `);
}
function saveSupport() {
  answers.supported = document.getElementById('sup').value;
  (answers.supported === 'مدعوم') ? askBundle() : askSalary();
}

// سؤال: هل ترغب في دفعة مقدمة من سكني؟
function askBundle() {
  show(`
    <label>هل ترغب بدفعة مقدّمة من سكني؟</label><br>
    <select id="bun"><option>نعم</option><option>لا</option></select><br>
    <button onclick="saveBundle()">التالي</button>
  `);
}
function saveBundle() {
  answers.bundle = document.getElementById('bun').value;
  askSalary();
}

// سؤال: الراتب الشهري
function askSalary() {
  show(`
    <label>الراتب الشهري (ريال):</label><br>
    <input type="number" id="sal"><br>
    <button onclick="saveSalary()">التالي</button>
  `);
}
function saveSalary() {
  answers.salary = parseFloat(document.getElementById('sal').value) || 0;
  askProfit();
}

// سؤال: هامش الربح السنوي
function askProfit() {
  show(`
    <label>هامش الربح السنوي (%):</label><br>
    <input type="number" id="pr"><br>
    <button onclick="saveProfit()">التالي</button>
  `);
}
function saveProfit() {
  answers.profitMargin = parseFloat(document.getElementById('pr').value) || 0;
  askDuration();
}

// سؤال: مدة التمويل
function askDuration() {
  const max = answers.financeType === 'تمويل شخصي' ? 60 : 360;
  const defaultVal = answers.financeType === 'تمويل شخصي' ? 60 : 240;
  show(`
    <label>مدة التمويل (أشهر):</label><br>
    <input type="range" id="dur" min="12" max="${max}" value="${defaultVal}"
           oninput="document.getElementById('dVal').innerText=this.value">
    <br><span id="dVal">${defaultVal}</span> شهر<br>
    <button onclick="saveDuration()">التالي</button>
  `);
}
function saveDuration() {
  answers.duration = parseInt(document.getElementById('dur').value);
  askHasCommit();
}

// سؤال: هل توجد التزامات؟
function askHasCommit() {
  show(`
    <label>هل لديك التزامات؟</label><br>
    <select id="hasC"><option>نعم</option><option>لا</option></select><br>
    <button onclick="saveHasCommit()">التالي</button>
  `);
}
function saveHasCommit() {
  (document.getElementById('hasC').value === 'نعم') ? askCommitType() : calculate();
}

/* ============ إدخال الالتزامات ============ */
function askCommitType(){
  show(`
    <label>نوع الالتزام:</label><br>
    <select id="ctype">
      <option>قرض شخصي</option>
      <option>قرض سيارة</option>
      <option>قرض استهلاكي</option>
    </select><br>
    <button onclick="saveCommitType()">التالي</button>
  `);
}
function saveCommitType(){ curCommit.type=document.getElementById('ctype').value; askCommitAmount(); }

function askCommitAmount(){
  show(`
    <label>قيمة القسط الشهري:</label><br>
    <input type="number" id="camt"><br>
    <button onclick="saveCommitAmount()">التالي</button>
  `);
}
function saveCommitAmount(){ curCommit.amount=parseFloat(document.getElementById('camt').value)||0; askCommitMonths(); }

function askCommitMonths(){
  show(`
    <label>عدد الأشهر المتبقية:</label><br>
    <input type="range" id="cmon" min="1" max="60" value="12"
      oninput="document.getElementById('cmonVal').innerText=this.value">
    <br><span id="cmonVal">12</span> شهر<br>
    <button onclick="saveCommitMonths()">التالي</button>
  `);
}
function saveCommitMonths(){
  curCommit.months=parseInt(document.getElementById('cmon').value);
  (curCommit.type==='قرض سيارة')?askLastPayQ():finishCommit(0);
}
function askLastPayQ(){
  show(`
    <label>هل توجد دفعة أخيرة؟</label><br>
    <select id="hasLast"><option>نعم</option><option>لا</option></select><br>
    <button onclick="saveLastPayQ()">التالي</button>
  `);
}
function saveLastPayQ(){ document.getElementById('hasLast').value==='نعم'?askLastPay():finishCommit(0); }
function askLastPay(){
  show(`
    <label>مبلغ الدفعة الأخيرة:</label><br>
    <input type="number" id="lastPay"><br>
    <button onclick="saveLastPay()">التالي</button>
  `);
}
function saveLastPay(){ finishCommit(parseFloat(document.getElementById('lastPay').value)||0); }

function finishCommit(last){
  curCommit.lastPayment=last;
  commitments.push({...curCommit});
  curCommit={};
  askMore();
}
function askMore(){
  show(`
    <label>هل لديك التزامات أخرى؟</label><br>
    <select id="more"><option>نعم</option><option>لا</option></select><br>
    <button onclick="saveMore()">التالي</button>
  `);
}
function saveMore(){ document.getElementById('more').value==='نعم'?askCommitType():calculate(); }

/* ============ الحسبة النهائية ============ */
function calculate(){
  const S=answers.salary,
        dur=answers.duration,
        rate=answers.profitMargin,
        type=answers.financeType;

  /* نسب الاستقطاع */
  const baseDed = (type==='تمويل شخصي'?0.3333:(S<15000?0.55:0.65));
  const dedWithCommit = type==='تمويل شخصي'?0.45:baseDed;

  /* بناء جدول فترات الالتزامات */
  let timeline=[{m:dur, commit:0}];
  commitments.forEach(c=>{
    distribute(c.amount,c.months,0);
    if(c.type==='قرض سيارة'&&c.lastPayment){
      const extra=c.lastPayment/24;
      distribute(extra,Math.min(24,dur),dur-24);   // الدفعة الأخيرة على آخر 24 شهر
    }
  });

  /* احتساب القسط الشخصي في كل فترة */
  let personalCap=S*0.3333, totalWithProfit=0, html='';
  timeline.forEach(seg=>{
    let maxInstall=S*(seg.commit?dedWithCommit:baseDed);
    let personal=Math.min(Math.max(maxInstall-seg.commit,0),personalCap);
    if(type!=='تمويل شخصي') personal=maxInstall-seg.commit;   // العقاري كما هو
    totalWithProfit+=personal*seg.m;
    html+=`<p><strong>قسط التمويل لـ ${seg.m} شهر:</strong> ${personal.toFixed(0)} ريال</p>`;
  });

  const factor=(dur/12)*(rate/100)+1;
  const netFinance= totalWithProfit/factor;
  const fee=Math.min(netFinance*0.01,5000);
  const vat=Math.min(fee*0.15,750);
  const netAfter=netFinance-(fee+vat);

  show(`
    <h2>نتيجة الحاسبة:</h2>
    ${html}
    <p><strong>التمويل الصافي قبل الرسوم:</strong> ${netFinance.toFixed(0)} ريال</p>
    <p><strong>الرسوم الإدارية:</strong> ${fee.toFixed(0)} ريال</p>
    <p><strong>ضريبة الرسوم:</strong> ${vat.toFixed(0)} ريال</p>
    <p><strong>التمويل الصافي بعد الرسوم:</strong> ${netAfter.toFixed(0)} ريال</p>
    <p><strong>الربح:</strong> ${(netFinance-netAfter).toFixed(0)} ريال</p>
    <h3>📞 للتواصل: 0506214458 – hlooleqrr.com</h3>
  `);

  /* توزيع الالتزامات على الـ timeline */
  function distribute(amount, months, startAt){
    startAt=startAt||0; if(months<=0) return;
    let passed=0;
    for(let i=0;i<timeline.length;i++){
      const seg=timeline[i], segStart=passed, segEnd=passed+seg.m;
      if(startAt>=segEnd){ passed=segEnd; continue; }
      const over = Math.min(segEnd,startAt+months)-Math.max(segStart,startAt);
      if(over>0){
        const before=Math.max(0,startAt-segStart);
        const middle=over, after=seg.m-before-middle;
        timeline.splice(i,1);
        if(after>0) timeline.splice(i,0,{m:after,commit:seg.commit});
        timeline.splice(i,0,{m:middle,commit:seg.commit+amount});
        if(before>0) timeline.splice(i,0,{m:before,commit:seg.commit});
        break;
      }
    }
  }
}
</script>