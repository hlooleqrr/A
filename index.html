<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>حاسبة التمويل – سرعة تملك العقار</title>
  <style>
    body{font-family:'Tajawal',sans-serif;background:#f4f6f8;margin:0;text-align:center}
    header{background:#005c48;color:#fff;padding:20px}
    .container{max-width:600px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.1)}
    input,select,button{width:90%;padding:10px;margin:10px 0;font-size:16px;border-radius:5px;border:1px solid #ccc}
    input[type=range]::-webkit-slider-thumb { pointer-events: auto; }
    button{background:#00796b;color:#fff;border:none;cursor:pointer}
    button:hover{background:#004d40}
    footer{font-size:12px;color:#666;margin-top:40px;padding:10px}
    .fade-in{opacity:0;transform:translateY(20px);animation:fadeIn .6s forwards}
    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
<header>
  <h1>سرعة تملك العقار والحلول التمويلية</h1>
  <p>حاسبة التمويل التقريبية</p>
</header>

<div class="container" id="form-container">
  <div id="question"></div>
  <button onclick="nextQuestion()" id="mainBtn">ابدأ الحسبة</button>
</div>

<script>
let answers = {commitments: []};
let step = 0, commitmentIndex = 0;
const months60 = Array.from({length:60},(_,i)=>i+1);
const months360 = Array.from({length:360},(_,i)=>i+1);

const baseQuestions = [
  {id:'financeType', label:'نوع التمويل', type:'select', options:['تمويل عقاري','تمويل شخصي']},
  {id:'supported', label:'هل التمويل مدعوم؟', type:'select', options:['مدعوم','غير مدعوم'], show:a=>a.financeType==='تمويل عقاري'},
  {id:'bundle', label:'هل ترغب في دفعة مقدمة من سكني؟', type:'select', options:['نعم','لا'], show:a=>a.supported==='مدعوم'},
  {id:'salary', label:'كم الراتب الشهري؟', type:'number'},
  {id:'months', label:'عدد الأشهر للتمويل', type:'range', min:12, max:360, value:240},
  {id:'profitMargin', label:'نسبة هامش الربح السنوي (%)؟', type:'number'},
  {id:'hasCommitments', label:'هل لديك التزامات؟', type:'select', options:['نعم','لا']}
];

function showQuestion(){
  const zone = document.getElementById('question');
  zone.innerHTML = '';
  const q = getCurrentQuestion();
  if (!q) { calculate(); document.getElementById('mainBtn').textContent = 'أعد الحسبة'; return; }
  if (q.show && !q.show(answers)) { step++; showQuestion(); return; }

  const wrap = document.createElement('div'); wrap.className = 'fade-in';
  wrap.innerHTML = `<label>${q.label}</label><br/>`;
  if (q.type === 'select') {
    const sel = document.createElement('select'); sel.id = q.id;
    q.options.forEach(o => sel.add(new Option(o, o))); wrap.appendChild(sel);
  } else if (q.type === 'range') {
    const input = document.createElement('input');
    input.type = 'range'; input.min = q.min; input.max = q.max; input.step = 1;
    input.value = q.value; input.id = q.id;
    const val = document.createElement('span'); val.id = q.id + 'Val'; val.textContent = q.value;
    input.oninput = () => val.textContent = input.value;
    wrap.append(input, ' ', val, ' شهر');
  } else {
    const inp = document.createElement('input'); inp.type = 'number'; inp.id = q.id; wrap.appendChild(inp);
  }
  zone.appendChild(wrap);
}

function getCurrentQuestion(){
  if (step < baseQuestions.length) return baseQuestions[step];
  if (answers.hasCommitments === 'نعم') {
    const c = answers.commitments[commitmentIndex] || {};
    if (!c.type) return {id:'type', type:'select', label:'نوع الالتزام', options:['قرض شخصي','قرض سيارة','قرض استهلاكي']};
    if (!c.amount) return {id:'amount', type:'number', label:'كم القسط الشهري؟'};
    if (!c.months) return {id:'monthsRemain', type:'select', label:'عدد الأشهر المتبقية', options:months60.map(m=>m+' شهر')};
    if (c.type==='قرض سيارة' && c.months && !c.hasBalloon) return {id:'hasBalloon', type:'select', label:'هل لديك دفعة أخيرة؟', options:['نعم','لا']};
    if (c.hasBalloon==='نعم' && !c.balloon) return {id:'balloon', type:'number', label:'كم مبلغ الدفعة الأخيرة؟'};
    if (!c.askMore) return {id:'more', type:'select', label:'هل لديك التزامات أخرى؟', options:['نعم','لا']};
  }
  return null;
}

function nextQuestion(){
  const q = getCurrentQuestion(); if (!q) return;
  const val = document.getElementById(q.id)?.value || null;

  if (step < baseQuestions.length) {
    answers[q.id] = q.type === 'number' ? parseFloat(val) : val;
    if (q.id === 'financeType') {
      const mQ = baseQuestions.find(x => x.id === 'months');
      mQ.max = (val === 'تمويل شخصي') ? 60 : 360;
      mQ.value = (val === 'تمويل شخصي') ? 60 : 240;
    }
    step++;
  } else {
    let c = answers.commitments[commitmentIndex] || {};
    if (!c.type) c.type = val;
    else if (!c.amount) c.amount = parseFloat(val)||0;
    else if (!c.months) c.months = parseInt(val)||0;
    else if (c.type==='قرض سيارة' && c.months && c.hasBalloon === undefined) c.hasBalloon = val;
    else if (c.hasBalloon==='نعم' && !c.balloon) c.balloon = parseFloat(val)||0;
    else if (!c.askMore) {
      c.askMore = val;
      if (val === 'نعم') { commitmentIndex++; answers.commitments.push({}); }
    }
    answers.commitments[commitmentIndex] = c;
  }
  showQuestion();
}

function calculate(){
  const salary = +answers.salary || 0;
  const months = +answers.months || 0;
  const years = months / 12;
  const profit = +answers.profitMargin || 0;
  const type = answers.financeType;

  let maxRate = 0, maxInstall = 0, addCommodity = false, extraSupport = 0;
  if (type === 'تمويل شخصي') {
    maxRate = 45;
    maxInstall = salary * 0.3333;
    addCommodity = true;
  } else {
    maxRate = (salary >= 15000 || (answers.supported==='مدعوم' && answers.bundle==='لا')) ? 65 : 55;
    maxInstall = salary * maxRate / 100;
    if (answers.supported==='مدعوم' && answers.bundle==='نعم') extraSupport = salary<10000 ? 150000 : 100000;
  }

  let timeline = Array(months).fill(0);
  answers.commitments.forEach(c=>{
    for (let i=0; i<c.months; i++) {
      timeline[i] += c.amount || 0;
    }
    if (c.type==='قرض سيارة' && c.hasBalloon==='نعم' && c.balloon){
      for(let i=months-24;i<months;i++){
        timeline[i] += (c.balloon/24)||0;
      }
    }
  });

  let newInstall = Array(months).fill(0);
  for (let i=0;i<months;i++) {
    const used = timeline[i] || 0;
    const allowed = type==='تمويل شخصي'
      ? Math.min(salary*0.45 - used, maxInstall)
      : Math.max(0, salary*maxRate/100 - used);
    newInstall[i] = Math.max(0, allowed);
  }

  const totalWithProfit = newInstall.reduce((sum,v)=>sum+v,0);
  const profitFactor = years * profit / 100 + 1;
  const netFinance = totalWithProfit / profitFactor;

  let admin = netFinance * 0.01, vat = admin * 0.15;
  if (admin+vat > 5750) { admin = 5000; vat = 750; }
  const commodity = addCommodity ? netFinance * 0.01 : 0;
  const finalNet = netFinance - admin - vat - commodity;
  const finalPlus = finalNet + extraSupport;
  const withFeesProfit = totalWithProfit - finalNet;
  const withoutFeesProfit = netFinance * (profitFactor - 1);

  document.getElementById('question').innerHTML = `
    <h2>نتيجة الحاسبة:</h2>
    <p><strong>قسطك الشهري خلال فترة الالتزامات:</strong> ${Math.round(Math.min(...newInstall))} ريال</p>
    <p><strong>ثم قسطك بعد انتهاء الالتزامات:</strong> ${Math.round(Math.max(...newInstall))} ريال</p>
    <p><strong>اجمالي التمويل مع الأرباح:</strong> ${Math.round(totalWithProfit)} ريال</p>
    <p><strong>معامل الربح:</strong> ${profitFactor.toFixed(3)}</p>
    <p><strong>التمويل الصافي قبل الرسوم:</strong> ${Math.round(netFinance)} ريال</p>
    <p><strong>الرسوم الإدارية:</strong> ${Math.round(admin)} ريال</p>
    <p><strong>الضريبة على الرسوم:</strong> ${Math.round(vat)} ريال</p>
    ${addCommodity?`<p><strong>رسوم السلع:</strong> ${Math.round(commodity)} ريال</p>`:''}
    <p><strong>التمويل الصافي النهائي:</strong> ${Math.round(finalNet)} ريال</p>
    ${extraSupport?`<p><strong>دعم حكومي مضاف:</strong> ${extraSupport.toLocaleString()} ريال</p>`:''}
    <p><strong>الربح دون الرسوم:</strong> ${Math.round(withoutFeesProfit)} ريال</p>
    <p><strong>الربح مع الرسوم:</strong> ${Math.round(withFeesProfit)} ريال</p>
    <h3 style="margin-top:20px;">📞 للتواصل: 0506214458 – hlooleqrr.com</h3>
  `;
}

function updateDateTime(){
  const d = new Date();
  document.getElementById('datetime').textContent =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
</script>

<footer>
  <p>جميع الحقوق محفوظة – سرعة تملك العقار والحلول التمويلية – <span id="datetime"></span></p>
</footer>
<script>setInterval(updateDateTime,1000); updateDateTime();</script>
</body>
</html>