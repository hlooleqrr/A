<script>
let answers = {}, commitments = [], curCommit = {};

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
function show(html) {
  document.getElementById('question').innerHTML = '<div class="fade-in">' + html + '</div>';
}

// Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
function start() {
  document.getElementById('startBtn').innerText = 'Ø£Ø¹Ø¯ Ø§Ù„Ø­Ø³Ø¨Ø©';
  answers = {}; commitments = []; curCommit = {};
  askFinanceType();
}

// Ø³Ø¤Ø§Ù„: Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„
function askFinanceType() {
  show(`
    <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„:</label><br>
    <select id="ft">
      <option>ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ</option>
      <option>ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ</option>
    </select><br>
    <button onclick="saveFinanceType()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}

// Ø­ÙØ¸ Ù†ÙˆØ¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„
function saveFinanceType() {
  answers.financeType = document.getElementById('ft').value;
  (answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ') ? askSupport() : askSalary();
}

// Ø³Ø¤Ø§Ù„: Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ
function askSupport() {
  show(`
    <label>Ù‡Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ø¯Ø¹ÙˆÙ…ØŸ</label><br>
    <select id="sup"><option>Ù…Ø¯Ø¹ÙˆÙ…</option><option>ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</option></select><br>
    <button onclick="saveSupport()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveSupport() {
  answers.supported = document.getElementById('sup').value;
  (answers.supported === 'Ù…Ø¯Ø¹ÙˆÙ…') ? askBundle() : askSalary();
}

// Ø³Ø¤Ø§Ù„: Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ
function askBundle() {
  show(`
    <label>Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† Ø³ÙƒÙ†ÙŠØŸ</label><br>
    <select id="bun"><option>Ù†Ø¹Ù…</option><option>Ù„Ø§</option></select><br>
    <button onclick="saveBundle()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveBundle() {
  answers.bundle = document.getElementById('bun').value;
  askSalary();
}

// Ø³Ø¤Ø§Ù„: Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ
function askSalary() {
  show(`
    <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±ÙŠØ§Ù„):</label><br>
    <input type="number" id="sal"><br>
    <button onclick="saveSalary()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveSalary() {
  answers.salary = parseFloat(document.getElementById('sal').value) || 0;
  askProfit();
}

// Ø³Ø¤Ø§Ù„: Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ
function askProfit() {
  show(`
    <label>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ (%):</label><br>
    <input type="number" id="pr"><br>
    <button onclick="saveProfit()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveProfit() {
  answers.profitMargin = parseFloat(document.getElementById('pr').value) || 0;
  askDuration();
}

// Ø³Ø¤Ø§Ù„: Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„
function askDuration() {
  const max = answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ' ? 60 : 360;
  const defaultVal = answers.financeType === 'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ' ? 60 : 240;
  show(`
    <label>Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ (Ø£Ø´Ù‡Ø±):</label><br>
    <input type="range" id="dur" min="12" max="${max}" value="${defaultVal}"
           oninput="document.getElementById('dVal').innerText=this.value">
    <br><span id="dVal">${defaultVal}</span> Ø´Ù‡Ø±<br>
    <button onclick="saveDuration()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveDuration() {
  answers.duration = parseInt(document.getElementById('dur').value);
  askHasCommit();
}

// Ø³Ø¤Ø§Ù„: Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ
function askHasCommit() {
  show(`
    <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŸ</label><br>
    <select id="hasC"><option>Ù†Ø¹Ù…</option><option>Ù„Ø§</option></select><br>
    <button onclick="saveHasCommit()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveHasCommit() {
  (document.getElementById('hasC').value === 'Ù†Ø¹Ù…') ? askCommitType() : calculate();
}

/* ============ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ============ */
function askCommitType(){
  show(`
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…:</label><br>
    <select id="ctype">
      <option>Ù‚Ø±Ø¶ Ø´Ø®ØµÙŠ</option>
      <option>Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©</option>
      <option>Ù‚Ø±Ø¶ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒÙŠ</option>
    </select><br>
    <button onclick="saveCommitType()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveCommitType(){ curCommit.type=document.getElementById('ctype').value; askCommitAmount(); }

function askCommitAmount(){
  show(`
    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ:</label><br>
    <input type="number" id="camt"><br>
    <button onclick="saveCommitAmount()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveCommitAmount(){ curCommit.amount=parseFloat(document.getElementById('camt').value)||0; askCommitMonths(); }

function askCommitMonths(){
  show(`
    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label><br>
    <input type="range" id="cmon" min="1" max="60" value="12"
      oninput="document.getElementById('cmonVal').innerText=this.value">
    <br><span id="cmonVal">12</span> Ø´Ù‡Ø±<br>
    <button onclick="saveCommitMonths()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveCommitMonths(){
  curCommit.months=parseInt(document.getElementById('cmon').value);
  (curCommit.type==='Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©')?askLastPayQ():finishCommit(0);
}
function askLastPayQ(){
  show(`
    <label>Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø© Ø£Ø®ÙŠØ±Ø©ØŸ</label><br>
    <select id="hasLast"><option>Ù†Ø¹Ù…</option><option>Ù„Ø§</option></select><br>
    <button onclick="saveLastPayQ()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveLastPayQ(){ document.getElementById('hasLast').value==='Ù†Ø¹Ù…'?askLastPay():finishCommit(0); }
function askLastPay(){
  show(`
    <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©:</label><br>
    <input type="number" id="lastPay"><br>
    <button onclick="saveLastPay()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveLastPay(){ finishCommit(parseFloat(document.getElementById('lastPay').value)||0); }

function finishCommit(last){
  curCommit.lastPayment=last;
  commitments.push({...curCommit});
  curCommit={};
  askMore();
}
function askMore(){
  show(`
    <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ø®Ø±Ù‰ØŸ</label><br>
    <select id="more"><option>Ù†Ø¹Ù…</option><option>Ù„Ø§</option></select><br>
    <button onclick="saveMore()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  `);
}
function saveMore(){ document.getElementById('more').value==='Ù†Ø¹Ù…'?askCommitType():calculate(); }

/* ============ Ø§Ù„Ø­Ø³Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ============ */
function calculate(){
  const S=answers.salary,
        dur=answers.duration,
        rate=answers.profitMargin,
        type=answers.financeType;

  /* Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ */
  const baseDed = (type==='ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ'?0.3333:(S<15000?0.55:0.65));
  const dedWithCommit = type==='ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ'?0.45:baseDed;

  /* Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ ÙØªØ±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª */
  let timeline=[{m:dur, commit:0}];
  commitments.forEach(c=>{
    distribute(c.amount,c.months,0);
    if(c.type==='Ù‚Ø±Ø¶ Ø³ÙŠØ§Ø±Ø©'&&c.lastPayment){
      const extra=c.lastPayment/24;
      distribute(extra,Math.min(24,dur),dur-24);   // Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¹Ù„Ù‰ Ø¢Ø®Ø± 24 Ø´Ù‡Ø±
    }
  });

  /* Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ ÙƒÙ„ ÙØªØ±Ø© */
  let personalCap=S*0.3333, totalWithProfit=0, html='';
  timeline.forEach(seg=>{
    let maxInstall=S*(seg.commit?dedWithCommit:baseDed);
    let personal=Math.min(Math.max(maxInstall-seg.commit,0),personalCap);
    if(type!=='ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ') personal=maxInstall-seg.commit;   // Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ
    totalWithProfit+=personal*seg.m;
    html+=`<p><strong>Ù‚Ø³Ø· Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù„Ù€ ${seg.m} Ø´Ù‡Ø±:</strong> ${personal.toFixed(0)} Ø±ÙŠØ§Ù„</p>`;
  });

  const factor=(dur/12)*(rate/100)+1;
  const netFinance= totalWithProfit/factor;
  const fee=Math.min(netFinance*0.01,5000);
  const vat=Math.min(fee*0.15,750);
  const netAfter=netFinance-(fee+vat);

  show(`
    <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©:</h2>
    ${html}
    <p><strong>Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³ÙˆÙ…:</strong> ${netFinance.toFixed(0)} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:</strong> ${fee.toFixed(0)} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø±Ø³ÙˆÙ…:</strong> ${vat.toFixed(0)} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³ÙˆÙ…:</strong> ${netAfter.toFixed(0)} Ø±ÙŠØ§Ù„</p>
    <p><strong>Ø§Ù„Ø±Ø¨Ø­:</strong> ${(netFinance-netAfter).toFixed(0)} Ø±ÙŠØ§Ù„</p>
    <h3>ğŸ“ Ù„Ù„ØªÙˆØ§ØµÙ„: 0506214458 â€“ hlooleqrr.com</h3>
  `);

  /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù€ timeline */
  function distribute(amount, months, startAt){
    startAt=startAt||0; if(months<=0) return;
    let passed=0;
    for(let i=0;i<timeline.length;i++){
      const seg=timeline[i], segStart=passed, segEnd=passed+seg.m;
      if(startAt>=segEnd){ passed=segEnd; continue; }
      const over = Math.min(segEnd,startAt+months)-Math.max(segStart,startAt);
      if(over>0){
        const before=Math.max(0,startAt-segStart);
        const middle=over, after=seg.m-before-middle;
        timeline.splice(i,1);
        if(after>0) timeline.splice(i,0,{m:after,commit:seg.commit});
        timeline.splice(i,0,{m:middle,commit:seg.commit+amount});
        if(before>0) timeline.splice(i,0,{m:before,commit:seg.commit});
        break;
      }
    }
  }
}
</script>