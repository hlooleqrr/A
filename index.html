<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>حاسبة التمويل – سرعة تملك العقار</title>

  <style>
    body{font-family:'Tajawal',sans-serif;background:#f4f6f8;margin:0;text-align:center}
    header{background:#005c48;color:#fff;padding:20px}
    .container{max-width:600px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;
               box-shadow:0 0 15px rgba(0,0,0,.1)}
    input,select,button{width:90%;padding:10px;margin:10px 0;font-size:16px;border-radius:5px;border:1px solid #ccc}
    button{background:#00796b;color:#fff;border:none;cursor:pointer}
    button:hover{background:#004d40}
    footer{font-size:12px;color:#666;margin-top:40px;padding:10px}
    .fade-in{opacity:0;transform:translateY(20px);animation:fadeIn .6s forwards}
    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<header>
  <h1>سرعة تملك العقار والحلول التمويلية</h1>
  <p>حاسبة التمويل التقريبية</p>
</header>

<div class="container" id="form-container">
  <div id="question"></div>
  <button onclick="nextQuestion()">ابدأ الحسبة</button>
</div>

<script>
/* ========== بيانات الأسئلة ========== */
let answers = {commitments: []};
let step = 0, commitmentIndex = 0;
const months60  = [...Array(60 ).keys()].map(x=>x+1);
const months360 = [...Array(360).keys()].map(x=>x+1);

const baseQuestions = [
  {id:'financeType', label:'نوع التمويل', type:'select', options:['تمويل عقاري','تمويل شخصي']},
  {id:'supported',  label:'هل التمويل مدعوم؟', type:'select', options:['مدعوم','غير مدعوم'],
    show:a=>a.financeType==='تمويل عقاري'},
  {id:'bundle', label:'هل ترغب في دفعة مقدمة من سكني؟',
    type:'select', options:['نعم','لا'], show:a=>a.supported==='مدعوم'},
  {id:'salary', label:'كم الراتب الشهري؟', type:'number'},
  {id:'months', label:'عدد الأشهر للتمويل', type:'range', min:1, max:360, value:240},
  {id:'profitMargin', label:'نسبة هامش الربح السنوي (%)؟', type:'number'},
  {id:'hasCommitments', label:'هل لديك التزامات؟',type:'select',options:['نعم','لا']}
];

/* ========== عرض السؤال الحالي ========== */
function showQuestion(){
  const zone=document.getElementById('question');
  zone.innerHTML='';
  const q=getCurrentQuestion();
  if(!q){ calculate(); document.querySelector('button').style.display='none'; return;}
  if(q.show && !q.show(answers)){step++;showQuestion();return;}

  const wrap=document.createElement('div');wrap.className='fade-in';
  wrap.innerHTML=`<label>${q.label}</label><br/>`;
  if(q.type==='select'){
    const sel=document.createElement('select');sel.id=q.id;
    q.options.forEach(o=>sel.add(new Option(o,o)));wrap.appendChild(sel);
  }else if(q.type==='range'){
    const input=document.createElement('input');
    input.type='range'; input.min=q.min; input.max=q.max; input.value=q.value;
    input.id=q.id; input.oninput=()=>val.textContent=input.value;
    const val=document.createElement('span');val.id=q.id+'Val';val.textContent=q.value;
    wrap.append(input,' ',val,' شهر');
  }else{const inp=document.createElement('input');inp.type='number';inp.id=q.id;wrap.appendChild(inp);}
  zone.appendChild(wrap);
}

function getCurrentQuestion(){
  if(step<baseQuestions.length) return baseQuestions[step];
  if(answers.hasCommitments==='نعم'){
    const c=answers.commitments[commitmentIndex]||{};
    if(!c.type)   return {id:'type',type:'select',label:'نوع الالتزام',options:['قرض شخصي','قرض سيارة','قرض استهلاكي']};
    if(!c.amount) return {id:'amount',type:'number',label:'كم القسط الشهري؟'};
    if(!c.months){
      return {id:'monthsRemain',type:'select',label:'عدد الأشهر المتبقية',
              options:months60.map(m=>m+' شهر')};
    }
    if(c.type==='قرض سيارة' && !c.balloonAsked){
      c.balloonAsked=true;
      return {id:'balloon',type:'number',label:'هل لديك دفعة أخيرة؟ اكتب المبلغ أو 0'};
    }
    if(!c.askMore) return {id:'more',type:'select',label:'هل لديك التزامات أخرى؟',options:['نعم','لا']};
  }
  return null;
}

/* ========== الانتقال للسؤال التالي ========== */
function nextQuestion(){
  const q=getCurrentQuestion(); if(!q) return;
  const val=document.getElementById(q.id)?.value||null;

  if(step<baseQuestions.length){ answers[q.id]=val; step++; }
  else{
    let c=answers.commitments[commitmentIndex]||{};
    if(!c.type) c.type=val;
    else if(!c.amount) c.amount=parseFloat(val)||0;
    else if(!c.months) c.months=parseInt(val)||0;
    else if(c.type==='قرض سيارة' && c.balloon===undefined){ c.balloon=parseFloat(val)||0; }
    else if(!c.askMore){
      c.askMore=val;
      if(val==='نعم'){commitmentIndex++;answers.commitments.push({});}
    }
    answers.commitments[commitmentIndex]=c;
  }

  /* ضبط سلايدر الأشهر حسب نوع التمويل */
  if(q.id==='financeType'){
    const monthsQ=baseQuestions.find(x=>x.id==='months');
    monthsQ.max = (val==='تمويل شخصي')?60:360;
    if(document.getElementById('months')) document.getElementById('months').max=monthsQ.max;
  }

  showQuestion();
}

/* ========== حساب النتيجة بالمنطق الأصلي مع الربح ========== */
function calculate(){
  const salary = +answers.salary||0,
        months = +answers.months||0,
        years  = months/12,
        profit = +answers.profitMargin||0,
        type   = answers.financeType;

  /* معدلات الخصم */
  let rate=0, extraSupport=0, addCommodity=false;
  if(type==='تمويل شخصي'){rate=45; addCommodity=true;}
  else{
    const sup=answers.supported,bundle=answers.bundle;
    rate = salary<15000?55:65;
    if(sup==='مدعوم'&&bundle==='نعم'){
      extraSupport = salary<10000?150000:100000;
    }
  }

  /* الالتزامات */
  let schedule=[];            // جدول الأقساط الشهرية
  let maxMonths=0;

  if(answers.hasCommitments==='نعم'){
    // بناء جدول الالتزامات
    let tempMonths=0;
    answers.commitments.forEach(c=>{
      const m=c.months||0;
      const amt=c.amount||0;
      maxMonths=Math.max(maxMonths,m);
      let balloonMonthly=0;
      if(c.type==='قرض سيارة' && c.balloon){
        // توزع على آخر 24 شهر من مدة الالتزام أو أقل إذا المدة أقل
        const distribute=Math.min(24,m);
        balloonMonthly=c.balloon/distribute;
      }
      for(let i=0;i<m;i++){
        schedule[i]=(schedule[i]||0)+amt+(i>=m-24?balloonMonthly:0);
      }
      tempMonths=Math.max(tempMonths,m);
    });
  }

  // استكمال الجدول حتى مدة التمويل المطلوبة
  for(let i=schedule.length;i<months;i++) schedule[i]=0;

  /* بناء قسط التمويل الشخصي التدريجي */
  const personalCap = salary*0.3333;
  const allowed     = salary*rate/100;

  let payments=[];
  for(let i=0;i<months;i++){
    const obligations=schedule[i]||0;
    const avail=allowed-obligations;
    const personal=Math.min(personalCap,avail>0?avail:0);
    payments[i]=personal;
  }

  /* التمويل العقاري: القسط ثابت حسب allowed-rate */
  if(type==='تمويل عقاري'){
    const cap = salary*rate/100 - (schedule[0]||0);
    payments = Array(months).fill(cap>0?cap:0);
  }

  /* حساب المبالغ */
  const totalInst = payments.reduce((a,b)=>a+b,0);
  const profitFactor = years*profit/100 + 1;
  const netFinance   = totalInst/profitFactor;

  /* الأرباح */
  const profitWithout = totalInst - netFinance;

  /* الرسوم */
  let admin=netFinance*0.01; if(admin>5000)admin=5000;
  const vat=admin*0.15; // 750 إذا admin 5000
  const commodity = addCommodity?netFinance*0.01:0;
  const feesTotal = admin+vat+commodity;
  const finalNet  = netFinance-feesTotal;
  const profitWith = profitWithout + feesTotal;

  /* عرض النتيجة */
  document.getElementById('question').innerHTML=`
    <h2>نتيجة الحاسبة:</h2>
    <p><strong>قسطك خلال أول ${months>0?months:0} شهر (قسطك الجديد):</strong> ${payments[0].toFixed(0)} ريال</p>
    <p><strong>ثم قسطك بعد انتهاء الالتزام:</strong> ${type==='تمويل شخصي'?personalCap.toFixed(0):(salary*rate/100).toFixed(0)} ريال</p>
    <p><strong>اجمالي التمويل مع الأرباح:</strong> ${totalInst.toFixed(0)} ريال</p>
    <p><strong>معامل الربح:</strong> ${profitFactor.toFixed(3)}</p>
    <p><strong>التمويل الصافي قبل الرسوم:</strong> ${netFinance.toFixed(0)} ريال</p>
    <p><strong>الرسوم الإدارية:</strong> ${admin.toFixed(0)} ريال</p>
    <p><strong>الضريبة على الرسوم:</strong> ${vat.toFixed(0)} ريال</p>
    ${addCommodity?`<p><strong>رسوم السلع:</strong> ${commodity.toFixed(0)} ريال</p>`:''}
    <p><strong>الربح دون الرسوم:</strong> ${profitWithout.toFixed(0)} ريال</p>
    <p><strong>الربح مع الرسوم:</strong> ${profitWith.toFixed(0)} ريال</p>
    <p><strong>التمويل الصافي النهائي:</strong> ${finalNet.toFixed(0)} ريال</p>
    ${extraSupport?`<p><strong>دعم حكومي مضاف:</strong> ${extraSupport.toLocaleString()} ريال</p>`:''}
    <h3 style="margin-top:20px;">📞 للتواصل: 0506214458 – hlooleqrr.com</h3>
  `;
}

/* تشغيل أول سؤال */
showQuestion();
</script>

<footer>
  <p>جميع الحقوق محفوظة – سرعة تملك العقار والحلول التمويلية – <span id="datetime"></span></p>
</footer>
<script>
function updateDateTime(){
  const d=new Date(); document.getElementById('datetime').textContent =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
setInterval(updateDateTime,1000); updateDateTime();
</script>

</body>
</html>