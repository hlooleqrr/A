<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>سرعة تملك العقار – حاسبة التمويل</title>
<style>
body{font-family:'Tajawal',sans-serif;background:#f4f6f8;margin:0;text-align:center}
header{background:#005c48;color:#fff;padding:24px 10px}
.container{max-width:600px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.1)}
input,select,button{width:90%;padding:10px;margin:10px 0;font-size:16px;border-radius:5px;border:1px solid #ccc}
button{background:#00796b;color:#fff;border:none;cursor:pointer}
button:hover{background:#004d40}
footer{font-size:12px;color:#666;margin-top:40px;padding:10px}
.fade-in{opacity:0;transform:translateY(20px);animation:fadeIn .4s forwards}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<header>
  <h1>سرعة تملك العقار والحلول التمويلية</h1>
  <p>حاسبة التمويل التقريبية</p>
</header>

<div class="container" id="form">
  <button id="startBtn" onclick="start()">ابدأ الحاسبة</button>
  <div id="question"></div>
</div>

<!--------------------  JavaScript  --------------------->
<script>
/* متغيرات عامة */
let answers={},commitments=[],curCommit={};

/* دالة عرض سؤال */
function show(html){
  document.getElementById('question').innerHTML='<div class="fade-in">'+html+'</div>';
  document.getElementById('startBtn').innerText='أعد الحسبة';
}

/* البداية */
function start(){ answers={};commitments=[];askFinanceType(); }

/* سلسلة الأسئلة الأساسية */
function askFinanceType(){
  show(`<label>نوع التمويل:</label><br>
        <select id="ft"><option>تمويل عقاري</option><option>تمويل شخصي</option></select><br>
        <button onclick="() => {}"></button>
        <button onclick="saveFinanceType()">التالي</button>`);
}
function saveFinanceType(){
  answers.financeType=document.getElementById('ft').value;
  answers.financeType==='تمويل عقاري'?askSupport():askSalary();
}
function askSupport(){
  show(`<label>هل التمويل مدعوم؟</label><br>
        <select id="sup"><option>مدعوم</option><option>غير مدعوم</option></select><br>
        <button onclick="saveSupport()">التالي</button>`);
}
function saveSupport(){ answers.supported=document.getElementById('sup').value; askBundle(); }
function askBundle(){
  show(`<label>هل ترغب بدفعة مقدّمة من سكني؟</label><br>
        <select id="bun"><option>نعم</option><option>لا</option></select><br>
        <button onclick="saveBundle()">التالي</button>`);
}
function saveBundle(){ answers.bundle=document.getElementById('bun').value; askSalary(); }
function askSalary(){
  show(`<label>الراتب الشهري (ريال):</label><br>
        <input type="number" id="sal"><br>
        <button onclick="saveSalary()">التالي</button>`);
}
function saveSalary(){ answers.salary=parseFloat(document.getElementById('sal').value)||0; askProfit(); }
function askProfit(){
  show(`<label>هامش الربح السنوي (%):</label><br>
        <input type="number" id="pr" value="3"><br>
        <button onclick="saveProfit()">التالي</button>`);
}
function saveProfit(){ answers.profitMargin=parseFloat(document.getElementById('pr').value)||0; askDuration(); }
function askDuration(){
  const max=answers.financeType==='تمويل شخصي'?60:360;
  const def=answers.financeType==='تمويل شخصي'?60:240;
  show(`<label>مدة التمويل (أشهر):</label><br>
        <input type="range" id="dur" min="12" max="${max}" value="${def}"
               oninput="document.getElementById('dVal').innerText=this.value">
        <br><span id="dVal">${def}</span> شهر<br>
        <button onclick="saveDuration()">التالي</button>`);
}
function saveDuration(){ answers.duration=parseInt(document.getElementById('dur').value); askHasCommit(); }
function askHasCommit(){
  show(`<label>هل لديك التزامات؟</label><br>
        <select id="has"><option>نعم</option><option>لا</option></select><br>
        <button onclick="saveHasCommit()">التالي</button>`);
}
function saveHasCommit(){ document.getElementById('has').value==='نعم'?askCommitType():calculate(); }

/* سلسلة إدخال التزام */
function askCommitType(){
  show(`<label>نوع الالتزام:</label><br>
        <select id="ctype"><option>قرض شخصي</option><option>قرض سيارة</option><option>قرض استهلاكي</option></select><br>
        <button onclick="saveCommitType()">التالي</button>`);
}
function saveCommitType(){ curCommit.type=document.getElementById('ctype').value; askCommitAmount(); }
function askCommitAmount(){
  show(`<label>قيمة القسط الشهري:</label><br>
        <input type="number" id="camt"><br>
        <button onclick="saveCommitAmount()">التالي</button>`);
}
function saveCommitAmount(){ curCommit.amount=parseFloat(document.getElementById('camt').value)||0; askCommitMonths(); }
function askCommitMonths(){
  show(`<label>الأشهر المتبقية:</label><br>
        <input type="range" id="cmon" min="1" max="60" value="12"
               oninput="document.getElementById('cmonVal').innerText=this.value">
        <br><span id="cmonVal">12</span> شهر<br>
        <button onclick="saveCommitMonths()">التالي</button>`);
}
function saveCommitMonths(){
  curCommit.months=parseInt(document.getElementById('cmon').value);
  curCommit.type==='قرض سيارة'?askLastPayQ():finishCommit(0);
}
function askLastPayQ(){
  show(`<label>هل لديك دفعة أخيرة؟</label><br>
        <select id="hasLast"><option>نعم</option><option>لا</option></select><br>
        <button onclick="saveLastPayQ()">التالي</button>`);
}
function saveLastPayQ(){ document.getElementById('hasLast').value==='نعم'?askLastPay():finishCommit(0); }
function askLastPay(){
  show(`<label>مبلغ الدفعة الأخيرة:</label><br>
        <input type="number" id="last"><br>
        <button onclick="saveLastPay()">التالي</button>`);
}
function saveLastPay(){ finishCommit(parseFloat(document.getElementById('last').value)||0); }
function finishCommit(last){ curCommit.lastPayment=last; commitments.push({...curCommit}); curCommit={}; askMore(); }
function askMore(){
  show(`<label>هل لديك التزامات أخرى؟</label><br>
        <select id="more"><option>نعم</option><option>لا</option></select><br>
        <button onclick="saveMore()">التالي</button>`);
}
function saveMore(){ document.getElementById('more').value==='نعم'?askCommitType():calculate(); }

/* حسبة التمويل */
function calculate(){
  const S=answers.salary, dur=answers.duration, rate=answers.profitMargin;
  const type=answers.financeType;
  /* حد الاستقطاع */
  let maxDed= type==='تمويل شخصي' && commitments.length?0.45: (type==='تمويل شخصي'?0.3333:(S<15000?0.55:0.65));
  let allowed = S*maxDed;
  /* التزامات شهرية أساسية */
  let monthsTimeline=[{m:dur,commit:0}]; // سنبني جدول بسيط للفترات المتغيرة
  commitments.forEach(c=>{
    /* أضف الفترة التي يغطيها الالتزام */
    addTimeline(c.months,c.amount);
    if(c.type==='قرض سيارة'&&c.lastPayment){ // دفعة أخيرة توزع
      const extra=c.lastPayment/24;
      const start= Math.min(dur-24, c.months);
      addTimeline(24,extra,start);
    }
  });
  /* الآن احسب القسط الشخصي الشهري في كل فترة */
  let htmlRes='<h2>نتيجة الحاسبة:</h2>', total=0;
  let personalCap=S*0.3333;
  monthsTimeline.forEach(seg=>{
    const commit=seg.commit;
    let personal= Math.min(Math.max(allowed-commit,0),personalCap);
    if(type!=='تمويل شخصي'){ personal = allowed-commit; }
    total += personal*seg.m;
    htmlRes += `<p><strong>قسط التمويل لمدة ${seg.m} شهر:</strong> ${personal.toFixed(0)} ريال (مع التزامات ${commit.toFixed(0)})</p>`;
  });
  /* أرباح وعوامل */
  const factor=(dur/12)*(rate/100)+1;
  const netFinance= total/factor;
  let fee=Math.min(5000, netFinance*0.01);
  let vat=Math.min(750, fee*0.15);
  const netAfter=netFinance-(fee+vat);
  htmlRes += `
    <p><strong>التمويل الصافي قبل الرسوم:</strong> ${netFinance.toFixed(0)} ريال</p>
    <p><strong>التمويل الصافي بعد الرسوم:</strong> ${netAfter.toFixed(0)} ريال</p>
    <p><strong>معامل الربح:</strong> ${factor.toFixed(3)}</p>
    <p><strong>الرسوم الإدارية:</strong> ${fee.toFixed(0)} ريال</p>
    <p><strong>ضريبة الرسوم:</strong> ${vat.toFixed(0)} ريال</p>
    <h3>📞 للتواصل: 0506214458 – hlooleqrr.com</h3>`;
  show(htmlRes);

  /* وظيفة تساعدنا على بناءtimeline */
  function addTimeline(m,amt,start=0){
    if(m<=0) return;
    /* قص الفترات حسب البداية والنهاية */
    let acc=0;
    for(let i=0;i<monthsTimeline.length;i++){
      const seg=monthsTimeline[i];
      const segStart=acc, segEnd=acc+seg.m;
      if(start>=segEnd){ acc=segEnd; continue; }
      const applyMonths=Math.min(segEnd, start+m)-Math.max(segStart,start);
      if(applyMonths<=0){ acc=segEnd;continue; }
      /* قسم الفترة إن لزم */
      const before=Math.max(0,start-segStart);
      const middle=applyMonths;
      const after=seg.m-before-middle;
      monthsTimeline.splice(i,1);
      if(after>0) monthsTimeline.splice(i,0,{m:after,commit:seg.commit});
      monthsTimeline.splice(i,0,{m:middle,commit:seg.commit+amt});
      if(before>0) monthsTimeline.splice(i,0,{m:before,commit:seg.commit});
      break;
    }
  }
}
</script>

<footer>
  <p>جميع الحقوق محفوظة لـ سرعة تملك العقار والحلول التمويلية – <span id="datetime"></span></p>
</footer>
<script>
setInterval(()=>{
  const d=new Date();
  document.getElementById('datetime').innerText=
    d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+
    String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
},1000);
</script>
</body>
</html>